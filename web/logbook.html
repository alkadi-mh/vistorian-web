<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="logbook_s.css">
        <link rel="stylesheet" href="https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css">
        <script type="text/javascript" src="../static/traces/trace.js"></script>
        <script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
        <script src="https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
        <script src="https://unpkg.com/jspdf@latest/dist/jspdf.umd.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.1.1/jspdf.umd.min.js"></script>


        <script type="text/javascript">
            const monthNames = ["January", "February", "March", "April", "May", "June",
                                 "July", "August", "September", "October", "November", "December"];
            class bookmark{
                constructor(id,createdOn,title){
                    this.id=id;
                    this.createdOn=createdOn;
                    this.title=title;
                    this.note="";
                    this.type="";
                    this.analysisOpts=[];
                    
                }
                updateBookmark(title,note,type){
                    this.title=title;
                    this.note=note;
                    this.type=type;
                }
                updateBookmarkTitle(title){
                    this.title=title;
                }
                updateBookmarkNotes(notes){
                    this.note=notes;
                }
                updateBookmarkType(BkType){
                    this.type=BkType;
                }
                updateBookmarkAnalysisType(chkbx_AnalysisGroup){
                    this.analysisOpts=[];
                    for (var i=0;i<chkbx_AnalysisGroup.length;i++){
                        if (chkbx_AnalysisGroup[i].checked){
                            this.analysisOpts.push(i);
                        }
                            
                    }
                }
                
                
            }
            class nodeLinkBookmark extends bookmark{
                constructor(networkType,id,createdOn,title,linkOpacity,nodeOpacity,nodeSize,edgeGap,linkWidth,labellingType,startTime,endTime){
                    super(id,createdOn,title);
                    this.networkType=networkType;
                    this.linkOpacity=linkOpacity;
                    this.nodeOpacity=nodeOpacity;
                    this.nodeSize=nodeSize;
                    this.edgeGap=edgeGap;
                    this.linkWidth=linkWidth;
                    this.labellingType=labellingType;
                    this.timeSliderStart=startTime;
                    this.timeSliderEnd=endTime;

                }
            }
            class matrixBookmark extends bookmark{
                constructor(networkType,id,createdOn,title,zoom,labellingType,startTime,endTime){
                    super(id,createdOn,title);
                    this.networkType=networkType;
                    this.zoom=zoom;
                    this.labellingType=labellingType;
                    this.timeSliderStart=startTime;
                    this.timeSliderEnd=endTime;

                }
            }
            class timeArchsBookmark extends bookmark{
                constructor(networkType,id,createdOn,title,labellingType,startTime,endTime){
                    super(id,createdOn,title);
                    this.networkType=networkType;
                    this.labellingType=labellingType;
                    this.timeSliderStart=startTime;
                    this.timeSliderEnd=endTime;

                }
            }
            class  mapBookmark extends bookmark{
                constructor(networkType,id,createdOn,title,nodeOverlap,linkOpacity,opacityOfPositionlessNodes,labellingType,startTime,endTime){
                    super(id,createdOn,title);
                    this.networkType=networkType;
                    this.nodeOverlap=nodeOverlap;
                    this.linkOpacity=linkOpacity;
                    this.opacityOfPositionlessNodes=opacityOfPositionlessNodes;
                    this.labellingType=labellingType;
                    this.timeSliderStart=startTime;
                    this.timeSliderEnd=endTime;

                }
            }
            function checkExistance(no,lstOpts){

                for (var i=0; i<lstOpts.length ; i++)
                    if (parseInt(no)===parseInt(lstOpts[i]))
                        return true;
                return false;
                    
            }
            var counter=0;
            var bookmarksJSONFile=[];
            function locateLogObj(logs,elementId){
                for (var i=0;i<logs.length;i++)
                    if (logs[i].id==elementId)
                        
                    return i;
            }

            
            function initializeJSON(){
                visBM = localStorage.getItem("vistorianBookmarks");
                logs = JSON.parse(visBM);
                var i;
                if (typeof logs !== "undefined" && logs!==null){
                    if (logs.length!=0 )
                        for ( i=0;i<logs.length;i++){
                            AddNewLog(logs[i].id,logs[i].createdOn,logs[i].title,logs[i].note,logs[i].type,logs[i].analysisOpts);
                    }
                    counter=logs[i-1].id;
                }
               
            }
            function updateLocalStorage(){
                bookmarksJSON = JSON.stringify(bookmarksJSONFile);
                localStorage.setItem("vistorianBookmarks", bookmarksJSON);
            }
            function updateHeader()
            {
                this.parentElement.parentElement.getElementsByClassName("collapsible")[0].innerHTML=this.value;
            }
            function AddNewLog(id,dateCreated,title,note,selectedType,analysisOptions){
                 var logs=document.getElementById("logs");
                //Create new log div
                var newDiv=document.createElement("div");
                var currentCounterValue;
                if (id==0){
                    counter++;
                    currentCounterValue=counter;
                }
                else{
                    currentCounterValue=id;
                }
                newDiv.id="div_log_"+currentCounterValue;

                 // create inner collapsible div
                 var newContentDiv=document.createElement("div");
                newContentDiv.id=currentCounterValue;
                newContentDiv.setAttribute("class","content");
                var timeLabelHeader=document.createElement("label");
                timeLabelHeader.innerHTML="Date/Time Created: &nbsp;&nbsp;&nbsp; ";
                timeLabelHeader.style="font-weight: bold;float:left;";
               
                var timeLabel=document.createElement("label");

                var btn_dateTime=document.createElement("span");
                btn_dateTime.id="btn_dateTime"+currentCounterValue;

                if (dateCreated==""){
                    var today = new Date();
                    var date = today.getDate() +'-'+ monthNames[today.getMonth()] +'-'+ today.getFullYear();
                    var time = today.getHours() + ":" + today.getMinutes();// + ":" + today.getSeconds();
                    timeLabel.innerHTML=date+ "  "+time;
                    btn_dateTime.innerHTML=date+ "  "+time;
                }
                else{
                    timeLabel.innerHTML=dateCreated;
                    btn_dateTime.innerHTML=dateCreated;
                }
 
                //create log collapsible title
                var headerButton=document.createElement("button");
                var btn_title=document.createElement("span");
                btn_title.id="btn_title_"+currentCounterValue;

                if (title!="")
                    btn_title.innerHTML=title;
                   // headerButton.innerHTML=btn_title.innerHTML + "<br/> " + btn_dateTime.innerHTML;
                else
                   // headerButton.innerHTML="Bookmark " + currentCounterValue +" : " +"<br/> " + date+ "&nbsp;&nbsp;"+time;
                    btn_title.innerHTML="Bookmark " + currentCounterValue +" : ";;

                headerButton.appendChild(btn_title);
                headerButton.appendChild(document.createElement("br"));
                headerButton.appendChild(btn_dateTime);
            
                headerButton.setAttribute("class","collapsible");
                
                headerButton.addEventListener("click", function() {
                    this.classList.toggle("active");
                    var content = this.nextElementSibling;
                    if (content.style.maxHeight){
                        content.style.maxHeight = null;
                    } else {
                    content.style.maxHeight = content.scrollHeight + "px";
                     } 
                });
 
                newDiv.appendChild(headerButton);


                // newContentDiv.appendChild(timeLabelHeader);
                // newContentDiv.appendChild(timeLabel);
                var lbl_title=document.createElement("label");
                lbl_title.innerText="Bookmark Label:"
                lbl_title.style="font-weight: bold;float:left;";

                var newTitle=document.createElement("input");
                newTitle.type="text";
                newTitle.id="txt_title_"+currentCounterValue;
                newTitle.placeholder="Update bookmark label here ..";
                newTitle.addEventListener('keyup', function() {
                    document.getElementById(btn_title.id).innerHTML=this.value;

                  //  this.parentElement.parentElement.getElementsByClassName("collapsible")[0].innerHTML=this.value;
                    //bookmarksJSONFile[locateLogObj(bookmarksJSONFile,this.parentElement.id)].updateBookmark(this.parentElement.getElementsByTagName("input")[0].value,this.parentElement.getElementsByTagName("textarea")[0].value,flagTypes[this.parentElement.getElementsByTagName("select")[0].selectedIndex]);
                    bookmarksJSONFile[locateLogObj(bookmarksJSONFile,this.parentElement.id)].updateBookmarkTitle(this.value);
                    updateLocalStorage();
                });

                lbl_title.htmlFor=newTitle.id;

                newContentDiv.appendChild(lbl_title);
                newContentDiv.appendChild(newTitle);
                newContentDiv.appendChild(document.createElement("br"));

                

                // Add bookmark type (purpose)
                var flagTypes=["Review Data Quality","Test a particular hypothesis","Compare different visualizations","Retrieve specific details","Repeat analysis with new data"];
                var bmTypeLabel=document.createElement("label");
                bmTypeLabel.innerText="Characterize your current activity: ";
                bmTypeLabel.style="font-weight: bold;";
                newContentDiv.appendChild(bmTypeLabel);
                
                var bmType=document.createElement("label");
                bmType.id="lbl_type_"+currentCounterValue;
                bmType.style="font-style: italic; ";
                if (selectedType!="")
                    bmType.innerText=selectedType;
                bmType.style.display="none";
                newContentDiv.appendChild(bmType);
                
                var generalPBtns=["Analyze Data","Learn","Demo to others","Test & Explore Vistorian","Report an Issue"];
                var btn= document.createElement("input");
                btn.type="button";
                btn.name="menuButton_"+currentCounterValue;
                btn.classList.add("menuButton"); 
                btn.style=" display: inline-block;";
                btn.value=generalPBtns[0];

                
                btn.addEventListener('click', function() {
                    document.getElementById(bmType.id).innerText=this.value;
                    frmChk.style.display="block";
                    txt_otherType.style.display="none";
                    document.getElementsByName(this.name).forEach((btn) => {
                            if(btn == this) 
                                btn.style.backgroundColor= "#FF7F50"; 
                            else 
                                btn.style.backgroundColor= "#bbb"; 
                             });
                    document.getElementById(newContentDiv.id).style.maxHeight=document.getElementById(newContentDiv.id).scrollHeight + "px";
                    bookmarksJSONFile[locateLogObj(bookmarksJSONFile,this.parentElement.id)].updateBookmarkType(document.getElementById(bmType.id).innerText);
                    updateLocalStorage();

                });
                   newContentDiv.appendChild(btn);
                for (var i=1;i<generalPBtns.length;i++){
                   var btn= document.createElement("input");
                   btn.type="button";
                   btn.classList.add("menuButton"); 
                   btn.style=" display: inline-block;";
                   btn.name="menuButton_"+currentCounterValue;
                   btn.value=generalPBtns[i];
                   btn.addEventListener('click', function() {
                        document.getElementById(bmType.id).innerText=this.value;
                        document.getElementsByName(this.name).forEach((btn) => {
                            if(btn == this) 
                                btn.style.backgroundColor= "#FF7F50"; 
                            else 
                                btn.style.backgroundColor= "#bbb"; 
                             });
                        txt_otherType.style.display="none";
                        frmChk.style.display="none";
                        bookmarksJSONFile[locateLogObj(bookmarksJSONFile,this.parentElement.id)].updateBookmarkType(document.getElementById(bmType.id).innerText);
                        updateLocalStorage();
                   });
                   newContentDiv.appendChild(btn);
                }
                btn= document.createElement("input");
                btn.type="button";
                btn.value="Other";
                btn.classList.add("menuButton"); 
                btn.name="menuButton_"+currentCounterValue;
                btn.addEventListener('click', function() {
                        if (document.getElementById(bmType.id).innerText.length==0)
                            document.getElementById(bmType.id).innerText=this.value;
                        
                        document.getElementsByName(this.name).forEach((btn) => {
                            if(btn == this) 
                                btn.style.backgroundColor= "#FF7F50"; 
                            else 
                                btn.style.backgroundColor= "#bbb"; 
                             });
                        if (txt_otherType.style.display=="none"){
                            txt_otherType.style.display="inline-block";
                            document.getElementById(newContentDiv.id).style.maxHeight=document.getElementById(newContentDiv.id).scrollHeight + "px";
                        }
                        bookmarksJSONFile[locateLogObj(bookmarksJSONFile,this.parentElement.id)].updateBookmarkType(document.getElementById(bmType.id).innerText);
                        updateLocalStorage();   
                });
                newContentDiv.appendChild(btn);
                document.getElementsByName(btn.name).forEach((bmT) => {
                    alert(bmT.value + " " + selectedType);
                    if(bmT.value == selectedType)
                        bmT.style.backgroundColor= "#FF7F50"; 
                });
                
                var txt_otherType=document.createElement("textarea");
                txt_otherType.placeholder="Explian other type here .. Please don't add personal information";
                if (bmType.innerText==generalPBtns[generalPBtns.length-1])
                    txt_otherType.style.display="block";
                else
                    txt_otherType.style.display="none";
                
                
                txt_otherType.addEventListener('keyup', function() {
                    document.getElementById(bmType.id).innerText=this.value;
                    if (this.value.length==0)
                        document.getElementById(bmType.id).innerText="Other"; 
                    bookmarksJSONFile[locateLogObj(bookmarksJSONFile,this.parentElement.id)].updateBookmarkType(document.getElementById(bmType.id).innerText);
                    updateLocalStorage();
                });
                newContentDiv.appendChild(txt_otherType);
                

                
                var frmChk=document.createElement("form");
                frmChk.action="#";
                if (bmType.innerText==generalPBtns[0]){
                    frmChk.style.display="block";
                }
                else
                    frmChk.style.display="none";
                newContentDiv.appendChild(frmChk);
                var logFlag=document.createElement("fieldset");
                logFlag.name="fs_logType_"+currentCounterValue;
                var selectHeader=document.createElement('legend');
                selectHeader.style="font-weight: bold;";
                selectHeader.innerText="Characterize your analysis: ";
                logFlag.appendChild(selectHeader);
                 for(var i = 0; i < flagTypes.length; i++) {
                    var optChk=document.createElement("input");
                    optChk.type="checkbox";
                    optChk.value=i;
                    optChk.name="chkGroup_"+currentCounterValue;
                    optChk.id="chk_analysis_"+ currentCounterValue+"_"+(i+1);
                    optChk.style="float:left;";
                             
                    optChk.checked=checkExistance(optChk.value,analysisOptions);

                    optChk.addEventListener('click', function() {
                      
                        bookmarksJSONFile[locateLogObj(bookmarksJSONFile,this.name.charAt(this.name.length-1))].updateBookmarkAnalysisType(document.getElementsByName(this.name));
                        updateLocalStorage();
                    });
                    var opt = document.createElement('label');
                    opt.innerHTML = flagTypes[i];
                    opt.htmlFor = optChk.id;
                    
                    opt.appendChild(optChk);
                    logFlag.appendChild(opt);
                }
                frmChk.appendChild(logFlag);
                newContentDiv.appendChild(frmChk);
                
                var newNote=document.createElement("textarea");
                newNote.id="txt_note_"+currentCounterValue;
                newNote.rows=5;
                if (note!="")
                    newNote.value=note;
                newNote.placeholder="Enter your notes here ..";
                newNote.addEventListener('keyup', function() {
                    bookmarksJSONFile[locateLogObj(bookmarksJSONFile,this.parentElement.id)].updateBookmarkNotes(this.value);
                    updateLocalStorage();
                });
                var notesLabel=document.createElement("label");
                notesLabel.innerText="Notes:";
                notesLabel.style="font-weight: bold;";
                notesLabel.htmlFor=newNote.id;
                
                newContentDiv.appendChild(notesLabel);

                newContentDiv.appendChild(newNote);
               
               

                //Add buttons (Restore State|Delete)
                newContentDiv.appendChild(document.createElement("br"));
                newContentDiv.appendChild(document.createElement("br"));
                var restoreButton = document.createElement("input");
                restoreButton.type = "button";
                restoreButton.value="Restore Visualization State";
                restoreButton.addEventListener('click', function() {
                    

                });
                newContentDiv.appendChild(restoreButton);
                
                var deleteButton = document.createElement("input");
                deleteButton.type = "button";
                deleteButton.value="Delete Bookmark";
                //deleteButton.style="display:block;";
                
                deleteButton.addEventListener('click', function() {
                    if (confirm('Are you sure you want to Delete?')){
                        this.parentElement.parentElement.remove();
                        bookmarksJSONFile.splice(locateLogObj(bookmarksJSONFile,this.parentElement.id),1);
                        updateLocalStorage();
                    }
                    //logFileJSON.push();

                });
                newContentDiv.appendChild(deleteButton);
                newContentDiv.appendChild(document.createElement("br"));

                /* if (title!="")
                {
                    newContentDiv.style.height=   newContentDiv.scrollHeight +"px";
                } */
                newDiv.appendChild(newContentDiv);
                logs.appendChild(newDiv);

                var newBookmark=new bookmark(currentCounterValue,btn_dateTime.innerHTML,btn_title.innerHTML);
                bookmarksJSONFile.push(newBookmark);

            }
            function generatePDF(){
                var pdfMake = require('pdfmake/build/pdfmake.js');
                var pdfFonts = require('pdfmake/build/vfs_fonts.js');
                pdfMake.vfs = pdfFonts.pdfMake.vfs; 
                var doc = new jsPDF();
                bookmarksJSONFile.forEach(function(bookmark, i){
                    doc.text(20, 10 + (i * 10), 
                        "Title: " + bookmark.title + 
                        "Date/Time Created: " + bookmark.dateCreated +
                        "Note: " + bookmark.note + 
                        "Type: " + bookmark.type );
                    });
                    doc.save('vistorian_bookmarks.pdf');
            }
            function takeScreenShot() {
                 
            }
            
        </script>
    </head>
    <body id="capture" onload="initializeJSON();">
       
        <div id="logbook_container" data-role="page">
            <div>
                <form action="#">
                    <input type="radio" id="allBM" name="bmTypeSelection" value="all" checked>
                    <label for="allBM">Show all bookmarks</label>
                    <input type="radio" id="specificBM" name="bmTypeSelection" value="specific">
                    <label for="specificBM">Show only for this visualization </label><br>
                </form>
            </div>
            <div id="logbook_header"  class="hd_div" >

                <button  id="addNewBookmark" value="Add New" class="hd_btn"  onclick="AddNewLog(0,'','','','',[]);">Add New</button>
                <button  id="btn_save" value="Save" class="hd_btn"  onclick="updateLocalStorage();">Save Bookmarks</button>

          
            </div>
            <div id="logs" data-role="main" class="ui-content">

            </div>
            <div>
               <!-- <button onclick="generatePDF()">Export as a PDF</button>
                <button onclick="takeScreenShot()">Take Screenshot</button> -->
                <button onclick="location.href='mailto:vistorian@inria.fr?subject=(Vistorian)Consultation Request&body=Hi, kindly I would like to arrange a 10-minutes meeting to consult about my data\'s visualization. Thank you.';trace.event('com_3', document.location.pathname, 'bookmark_tool', 'consult_team');">Email Us & Consult an Expert</button>
                <button onclick="location.href='mailto:vistorian@inria.fr?subject=(Vistorian)Report Technical Bug&body=Please help me in the following technical problem:\n';trace.event('com_4', document.location.pathname, 'bookmark_tool', 'ReportTechBug');">Report a Technical Bug</button>
            </div>


        </div>

    </body>

</html>