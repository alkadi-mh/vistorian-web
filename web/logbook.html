<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="logbook_s.css">
        <link rel="stylesheet" href="https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css">
        <script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
        <script src="https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
        <script src="https://unpkg.com/jspdf@latest/dist/jspdf.umd.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.1.1/jspdf.umd.min.js"></script>


        <script type="text/javascript">
            class bookmark{
                constructor(id,createdOn,title){
                    this.id=id;
                    this.createdOn=createdOn;
                    this.title=title;
                    this.note="";
                    this.type="";
                    this.analysisOpts=[];
                }
                updateBookmark(title,note,type){
                    this.title=title;
                    this.note=note;
                    this.type=type;
                }
                updateBookmarkTitle(title){
                    this.title=title;
                }
                updateBookmarkNotes(notes){
                    this.note=notes;
                }
                updateBookmarkType(BkType){
                    this.type=BkType;
                }
                updateBookmarkAnalysisType(chkbx_AnalysisGroup){
                    this.analysisOpts=[];
                    for (var i=0;i<chkbx_AnalysisGroup.length;i++){
                        if (chkbx_AnalysisGroup[i].checked){
                            this.analysisOpts.push(i);
                        }
                            
                    }
                }
                
                
            }
            function checkExistance(no,lstOpts){

                for (var i=0; i<lstOpts.length ; i++)
                    if (parseInt(no)===parseInt(lstOpts[i]))
                        return true;
                return false;
                    
            }
            var counter=0;
            var bookmarksJSONFile=[];
            function locateLogObj(logs,elementId){
                for (var i=0;i<logs.length;i++)
                    if (logs[i].id==elementId)
                        
                    return i;
            }

            
            function initializeJSON(){
                visBM = localStorage.getItem("vistorianBookmarks");
                logs = JSON.parse(visBM);
                var i;
                if (typeof logs !== "undefined" && logs.length!=0){
                    for ( i=0;i<logs.length;i++){
                        AddNewLog(logs[i].id,logs[i].createdOn,logs[i].title,logs[i].note,logs[i].type,logs[i].analysisOpts);
                    }
                    counter=logs[i-1].id;
                }
               
            }
            function updateLocalStorage(){
                bookmarksJSON = JSON.stringify(bookmarksJSONFile);
                localStorage.setItem("vistorianBookmarks", bookmarksJSON);
            }
            function updateHeader()
            {
                this.parentElement.parentElement.getElementsByClassName("collapsible")[0].innerHTML=this.value;
            }
            function AddNewLog(id,dateCreated,title,note,selectedType,analysisOptions){
                 var logs=document.getElementById("logs");
                //Create new log div
                var newDiv=document.createElement("div");
                var currentCounterValue;
                if (id==0){
                    counter++;
                    currentCounterValue=counter;
                }
                else{
                    currentCounterValue=id;
                }
                newDiv.id="div_log_"+currentCounterValue;

 
                //create log collapsible title
                var headerButton=document.createElement("button");
                if (title!="")
                    headerButton.innerHTML=title;
                else
                    headerButton.innerHTML="Bookmark " + currentCounterValue +" : ";
                headerButton.setAttribute("class","collapsible");
                headerButton.addEventListener("click", function() {
                    this.classList.toggle("active");
                    var content = this.nextElementSibling;
                    if (content.style.maxHeight){
                        content.style.maxHeight = null;
                    } else {
                    content.style.maxHeight = content.scrollHeight + "px";
                     } 
                });
 
                newDiv.appendChild(headerButton);

                // create inner collapsible div
                var newContentDiv=document.createElement("div");
                newContentDiv.id=currentCounterValue;
                newContentDiv.setAttribute("class","content");
                var timeLabelHeader=document.createElement("label");
                timeLabelHeader.innerHTML="Date/Time Created:  ";
                timeLabelHeader.style="font-weight: bold;";
                newContentDiv.appendChild(timeLabelHeader);
                var timeLabel=document.createElement("label");
                if (dateCreated==""){
                    var today = new Date();
                    var date = today.getFullYear()+'-'+(today.getMonth()+1)+'-'+today.getDate();
                    var time = today.getHours() + ":" + today.getMinutes() + ":" + today.getSeconds();
                    timeLabel.innerHTML=date+'  '+time;
                }
                else{
                    timeLabel.innerHTML= dateCreated;
                }
                timeLabel.setAttribute("data-inline",true);

                newContentDiv.appendChild(timeLabel);
                var lbl_title=document.createElement("label");
                lbl_title.innerText="Bookmark Title:"
                lbl_title.style="font-weight: bold;";

                var newTitle=document.createElement("input");
                newTitle.type="text";
                newTitle.id="txt_title_"+currentCounterValue;
                newTitle.placeholder="Enter Bookmark title here ..";
                newTitle.addEventListener('keyup', function() {
                    this.parentElement.parentElement.getElementsByClassName("collapsible")[0].innerHTML=this.value;
                    //bookmarksJSONFile[locateLogObj(bookmarksJSONFile,this.parentElement.id)].updateBookmark(this.parentElement.getElementsByTagName("input")[0].value,this.parentElement.getElementsByTagName("textarea")[0].value,flagTypes[this.parentElement.getElementsByTagName("select")[0].selectedIndex]);
                    bookmarksJSONFile[locateLogObj(bookmarksJSONFile,this.parentElement.id)].updateBookmarkTitle(this.value);
                    updateLocalStorage();
                });

                lbl_title.htmlFor=newTitle.id;

                newContentDiv.appendChild(lbl_title);
                newContentDiv.appendChild(newTitle);
                newContentDiv.appendChild(document.createElement("br"));

                var newNote=document.createElement("textarea");
                newNote.id="txt_note_"+currentCounterValue;
                if (note!="")
                    newNote.value=note;
                newNote.placeholder="Enter your notes here ..";
                newNote.addEventListener('keyup', function() {
                    bookmarksJSONFile[locateLogObj(bookmarksJSONFile,this.parentElement.id)].updateBookmarkNotes(this.value);
                    updateLocalStorage();
                });
                var notesLabel=document.createElement("label");
                notesLabel.innerText="Bookmark Notes:";
                notesLabel.style="font-weight: bold;";
                notesLabel.htmlFor=newNote.id;
                
                newContentDiv.appendChild(notesLabel);

                newContentDiv.appendChild(newNote);
                newContentDiv.appendChild(document.createElement("br"));

                // Add bookmark type (purpose)
                var flagTypes=["Review Data Quality","Test a particular hypothesis","Compare different visualizations","Retrieve specific details","Repeat analysis with new data"];
                var bmTypeLabel=document.createElement("label");
                bmTypeLabel.innerText="Choose Bookmark Type: ";
                bmTypeLabel.style="font-weight: bold;";
                newContentDiv.appendChild(bmTypeLabel);
                
                var bmType=document.createElement("label");
                bmType.id="lbl_type_"+currentCounterValue;
                bmType.style="font-style: italic; ";
                if (selectedType!="")
                    bmType.innerText=selectedType;
                newContentDiv.appendChild(bmType);
                
                var generalPBtns=["Analyze Data","Learn","Demo to others","Test & Explore Vistorian"];
                var btn= document.createElement("input");
                btn.type="button";
                btn.style=" display: inline-block;";
                btn.value=generalPBtns[0];

                
                btn.addEventListener('click', function() {
                    document.getElementById(bmType.id).innerText=this.value;
                    frmChk.style.display="block";
                    txt_otherType.style.display="none";
                    document.getElementById(newContentDiv.id).style.maxHeight=document.getElementById(newContentDiv.id).scrollHeight + "px";
                    bookmarksJSONFile[locateLogObj(bookmarksJSONFile,this.parentElement.id)].updateBookmarkType(document.getElementById(bmType.id).innerText);
                    updateLocalStorage();

                });
                   newContentDiv.appendChild(btn);
                for (var i=1;i<generalPBtns.length;i++){
                   var btn= document.createElement("input");
                   btn.type="button";
                   btn.style=" display: inline-block;";
                   btn.value=generalPBtns[i];
                   btn.addEventListener('click', function() {
                        document.getElementById(bmType.id).innerText=this.value;
                        txt_otherType.style.display="none";
                        frmChk.style.display="none";
                        bookmarksJSONFile[locateLogObj(bookmarksJSONFile,this.parentElement.id)].updateBookmarkType(document.getElementById(bmType.id).innerText);
                        updateLocalStorage();
                   });
                   newContentDiv.appendChild(btn);
                }
                btn= document.createElement("input");
                btn.type="button";
                btn.value="Other";
                btn.addEventListener('click', function() {
                        if (document.getElementById(bmType.id).innerText.length==0)
                            document.getElementById(bmType.id).innerText=this.value;
                        if (txt_otherType.style.display=="none"){
                            txt_otherType.style.display="inline-block";
                            document.getElementById(newContentDiv.id).style.maxHeight=document.getElementById(newContentDiv.id).scrollHeight + "px";
                        }
                        bookmarksJSONFile[locateLogObj(bookmarksJSONFile,this.parentElement.id)].updateBookmarkType(document.getElementById(bmType.id).innerText);
                        updateLocalStorage();   
                });
                newContentDiv.appendChild(btn);
                var txt_otherType=document.createElement("textarea");
                txt_otherType.placeholder="Explian other type here ..";
                if (bmType.innerText==generalPBtns[generalPBtns.length-1])
                    txt_otherType.style.display="block";
                else
                    txt_otherType.style.display="none";
                
                
                txt_otherType.addEventListener('keyup', function() {
                    document.getElementById(bmType.id).innerText=this.value;
                    if (this.value.length==0)
                        document.getElementById(bmType.id).innerText="Other"; 
                    bookmarksJSONFile[locateLogObj(bookmarksJSONFile,this.parentElement.id)].updateBookmarkType(document.getElementById(bmType.id).innerText);
                    updateLocalStorage();
                });
                newContentDiv.appendChild(txt_otherType);
                
                
                var frmChk=document.createElement("form");
                frmChk.action="#";
                if (bmType.innerText==generalPBtns[0])
                    frmChk.style.display="block";
                else
                    frmChk.style.display="none";
                newContentDiv.appendChild(frmChk);
                var logFlag=document.createElement("fieldset");
                logFlag.name="fs_logType_"+currentCounterValue;
                var selectHeader=document.createElement('legend');
                selectHeader.style="font-weight: bold;";
                selectHeader.innerText="Please choose analysis type: ";
                logFlag.appendChild(selectHeader);
                 for(var i = 0; i < flagTypes.length; i++) {
                    var optChk=document.createElement("input");
                    optChk.type="checkbox";
                    optChk.value=i;
                    optChk.name="chkGroup_"+currentCounterValue;
                    optChk.id="chk_analysis_"+ currentCounterValue+"_"+(i+1);
                    optChk.style="float:left;";
                             
                    optChk.checked=checkExistance(optChk.value,analysisOptions);

                    optChk.addEventListener('click', function() {
                      
                        bookmarksJSONFile[locateLogObj(bookmarksJSONFile,this.name.charAt(this.name.length-1))].updateBookmarkAnalysisType(document.getElementsByName(this.name));
                        updateLocalStorage();
                    });
                    var opt = document.createElement('label');
                    opt.innerHTML = flagTypes[i];
                    opt.htmlFor = optChk.id;
                    
                    opt.appendChild(optChk);
                    logFlag.appendChild(opt);
                }
                frmChk.appendChild(logFlag);
                newContentDiv.appendChild(frmChk);
                
                
               

                //Add buttons (Restore State|Delete)
                newContentDiv.appendChild(document.createElement("br"));
                newContentDiv.appendChild(document.createElement("br"));
                var restoreButton = document.createElement("input");
                restoreButton.type = "button";
                restoreButton.value="Restore Visualization State";
                restoreButton.addEventListener('click', function() {
                    

                });
                newContentDiv.appendChild(restoreButton);
                
                var deleteButton = document.createElement("input");
                deleteButton.type = "button";
                deleteButton.value="Delete";
                //deleteButton.style="display:block;";
                
                deleteButton.addEventListener('click', function() {
                    if (confirm('Are you sure you want to Delete?')){
                        this.parentElement.parentElement.remove();
                        bookmarksJSONFile.splice(locateLogObj(bookmarksJSONFile,this.parentElement.id),1);
                        updateLocalStorage();
                    }
                    //logFileJSON.push();

                });
                newContentDiv.appendChild(deleteButton);
                newContentDiv.appendChild(document.createElement("br"));


                newDiv.appendChild(newContentDiv);
                logs.appendChild(newDiv);

                var newBookmark=new bookmark(currentCounterValue,timeLabel.innerHTML,headerButton.innerHTML);
                bookmarksJSONFile.push(newBookmark);

            }
            function generatePDF(){
                var pdfMake = require('pdfmake/build/pdfmake.js');
                var pdfFonts = require('pdfmake/build/vfs_fonts.js');
                pdfMake.vfs = pdfFonts.pdfMake.vfs; 
                var doc = new jsPDF();
                bookmarksJSONFile.forEach(function(bookmark, i){
                    doc.text(20, 10 + (i * 10), 
                        "Title: " + bookmark.title + 
                        "Date/Time Created: " + bookmark.dateCreated +
                        "Note: " + bookmark.note + 
                        "Type: " + bookmark.type );
                    });
                    doc.save('vistorian_bookmarks.pdf');
            }
            function takeScreenShot() {
                 
            }
            
        </script>
    </head>
    <body id="capture" onload="initializeJSON();">
       
        <div id="logbook_container" data-role="page">

            <div id="logbook_header" data-role="header">
                <label style="font-weight: bold;">  Vistorian Bookmarks </label>
                <input type="button" id="btn_save" value="Save" onclick="updateLocalStorage();">
                <input type="button" id="addNewBookmark" value="Add New " onclick="AddNewLog(0,'','','','',[]);">

            </div>
            <div id="logs" data-role="main" class="ui-content">

            </div>
            <div>
               <!-- <button onclick="generatePDF()">Export as a PDF</button>
                <button onclick="takeScreenShot()">Take Screenshot</button> -->

                <button onclick="location.href='mailto:vistorian@inria.fr?subject=(Vistorian)Consultation Request&body=Hi, kindly I would like to arrange a 10-minutes meeting to consult about my data\'s visualization. Thank you.'">Email Us & Consult an Expert</button>
                <button onclick="location.href='mailto:vistorian@inria.fr?subject=(Vistorian)Report Technical Bug&body=Please help me in the following technical problem:\n'">Report a Technical Bug</button>
            </div>


        </div>

    </body>

</html>